def allureBuildPassRate = 0
pipeline {
    agent any

    environment {
        ALLURE_RESULTS = 'allure-results'  // Directory where Allure results will be stored
        ALLURE_REPORTS = 'allure-report'  // Directory for Allure report
        EMAIL_RECIPIENT = 'vamsipenugurthi52@gmail.com'
    }

    stages {
        stage('Run Tests') {
            steps {
                script {
                    try {
                        echo 'Running the tests on runner.TestRunner...'
                        bat './gradlew clean test --tests "runner.TestRunner"'   
                    } catch (Exception e) {
                        echo "An error occurred while running tests."
                    }
                }
            }
        }

        stage('Generate Allure Report') {
            steps {
                script {
                    // Ensure allure results are generated by running allureReport task
                    bat 'allure generate allure-results -o allure-report --clean'
                    echo 'Generating Allure report...'
                    def props = readJSON file: 'allure-report/widgets/summary.json'
                    allureBuildPassRate = String.format("%.2f",, props.statistic.passed / props.statistic.total * 100)
                }
            }
        }

        stage('Publish Allure Report') {
            steps {
                // Publish Allure report in Jenkins using the Allure plugin
                allure includeProperties: false, jdk: '', results: [[path: "${ALLURE_RESULTS}"]]
            }
        }
    }

    post {
            success {
            echo 'Tests and Allure report generated successfully!'
            // Send email on success
            emailext (
                subject: "${env.JOB_NAME} - Build # ${env.BUILD_NUMBER} - ${currentBuild.result} (Pass Rate: ${allureBuildPassRate} %)",
                body: """Tests ran successfully and the Allure report was generated.
                     You can view the Allure Report here: ${env.BUILD_URL}allure-report""",
                from : "jenkins@no-reply.com",
                to: "${EMAIL_RECIPIENT}"
            )
        }
        failure {
            echo 'Test execution failed.'
        }

    }
}
